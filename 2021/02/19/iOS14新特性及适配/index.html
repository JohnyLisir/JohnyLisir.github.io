<!DOCTYPE html><html lang="zh-cn"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><title>iOS14新特性及适配 | JohnyLisir Blogs</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="[object Object]"><meta name="designer" content="minfive"><meta name="keywords" content="undefined"><meta name="description" content><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><link rel="canonical" href="https://JohnyLisir.github.io/2021/02/19/iOS14新特性及适配/index.html"><link rel="icon" type="image/png" href="https://blog.static.minfive.com/other/favicon.ico" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="JohnyLisir"><link rel="stylesheet" href="/scss/views/page/post.css"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(https://blog.static.minfive.com/other/loader.gif)"></div><div id="page" class="page js-hidden"><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="JohnyLisir" alt="JohnyLisir"><img src="https://tse3-mm.cn.bing.net/th/id/OIP.9mdniIPjAJJeHiOCdgBCbQAAAA?pid=Api&rs=1" alt="JohnyLisir"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="首页" title="首页">首页</a></li><li class="nav__item"><a href="/archives" alt="归档" title="归档">归档</a></li><li class="nav__item"><a href="/about" alt="关于" title="关于">关于</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="http://blog.static.minfive.com/post/18-08-05/843d1948e85e20653861c115389cc7cf.jpg" alt="iOS14新特性及适配"></div><header class="post__info"><h1 class="post__title">iOS14新特性及适配</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/">JohnyLi</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2021-02-19</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/iOS-Update/">iOS-Update</a></li></ul></div></div></header><div class="post__content"><ul><li><ol><li><a href="#all"><strong>适配点</strong></a><ul><li>1.1. <a href="#PhotoLibrary">相册</a></li><li>1.2. <a href="#Location">定位</a></li><li>1.3. <a href="#UIDatePicker">UIDatePicker</a></li><li>1.4. <a href="#UITableViewCell">UITableViewCell</a></li><li>1.5. <a href="#LocalNetwork">Local Network</a></li><li>1.6. <a href="#Wi-FiAddress">Wi-Fi Address</a></li><li>1.7. <a href="#Pasteboard">剪切板</a></li><li>1.8. <a href="#Record">相机和麦克风</a></li><li>1.9. <a href="#IDFA">IDFA</a></li><li>1.10. <a href="#AppStore">上传 AppStore</a></li></ul></li></ol></li><li><ol start="2"><li><a href="#Conclusion"><strong>总结</strong></a></li></ol></li></ul><h1 id="iOS14-适配"><a href="#iOS14-适配" class="headerlink" title="iOS14 适配"></a>iOS14 适配</h1><p>在6月份刚结束的首次线上 WWDC 2020 发布会上苹果向我们展示了新的 iOS14 系统。iOS14 的适配，很重要的一环就集中在用户隐私和安全方面。</p><p>在 iOS13 及以前，当用户首次访问应用程序时，会被要求开放大量权限，比如相册、定位、联系人，实际上该应用可能仅仅需要一个选择图片功能，却被要求开放整个照片库的权限，这确实是不合理的。对于相册，在 iOS14 中引入了 “LimitedPhotos Library” 的概念，用户可以授予应用访问其一部分的照片，对于应用来说，仅能读取到用户选择让应用来读取的照片，让我们看到了 Apple 对于用户隐私的尊重。这仅仅是一部分，在iOS14 中，可以看到诸多类似的保护用户隐私的措施，也需要我们升级适配。</p><p>本文主要分享一下 iOS14 上对于隐私授权的变更和部分适配方案，欢迎补充指正。</p><h2 id="1-适配点"><a href="#1-适配点" class="headerlink" title="1. 适配点"></a>1. <a name="all"></a>适配点</h2><h3 id="1-1-相册"><a href="#1-1-相册" class="headerlink" title="1.1. 相册"></a>1.1. <a name="PhotoLibrary"></a>相册</h3><p> iOS14 新增了“Limited Photo Library Access” 模式，在授权弹窗中增加了 Select Photo 选项。用户可以在 App 请求调用相册时选择部分照片让 App 读取。从 App 的视⻆来看，你的相册里就只有这几张照片，App 无法得知其它照片的存在。</p><p><img src="https:////upload-images.jianshu.io/upload_images/3087124-d82755893383624f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/395" alt="img"></p><p> iOS14 中当用户选择<br>“PHAuthorizationStatusLimited” 时，如果未进行适配，有可能会在每次触发相册功能时都进行弹窗询问用户是否需要修改照片权限。</p><p> 对于这种情况可通过在 Info.plist 中设置</p><p>“PHPhotoLibraryPreventAutomaticLimitedAccessAlert”的值为 YES 来阻止该弹窗反复弹出，并且可通过下面这个 API 来主动控制何时弹出PHPickerViewController 进行照片选择</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//引入头文件</span><br><span class="line">#import &lt;PhotosUI/PHPhotoLibrary+PhotosUISupport.h&gt;</span><br><span class="line"></span><br><span class="line">//调用</span><br><span class="line">[[PHPhotoLibrary sharedPhotoLibrary] presentLimitedLibraryPickerFromViewController:self];</span><br></pre></td></tr></table></figure><p> 在 iOS14 中官方推荐使用 PHPicker 来替代原 API 进行图片选择。PHPicker 为独立进程，会在视图最顶层进行展示，应用内无法对其进行截图也无法直接访问到其内的数据。</p><ul><li></li></ul><p>UIImagePickerController -&gt; PHPickerViewController， UIImagePickerViewController 功能受限，每次只能选择一张图片，将逐渐被废弃。</p><p><img src="https:////upload-images.jianshu.io/upload_images/3087124-236ce3fe0e44296b?imageMogr2/auto-orient/strip%7CimageView2/2/w/1080" alt="img"></p><ul><li><p>PHPicker 支持多选，支持搜索，支持按 image，video，livePhotos 等进行选择。</p><p><img src="https:////upload-images.jianshu.io/upload_images/3087124-9bec5e922553b8d5?imageMogr2/auto-orient/strip%7CimageView2/2/w/1080" alt="img"></p></li></ul><p> 新API及迁移demo:</p><p><img src="https:////upload-images.jianshu.io/upload_images/3087124-7b7fe58bc5f7cb3a?imageMogr2/auto-orient/strip%7CimageView2/2/w/1080" alt="img"></p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> () &lt;<span class="title">PHPickerViewControllerDelegate</span>&gt;</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">weak</span>, <span class="keyword">nonatomic</span>) <span class="keyword">IBOutlet</span> <span class="built_in">UIImageView</span> *imageView;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSArray</span>&lt;<span class="built_in">NSItemProvider</span> *&gt; *itemProviders;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></span><br><span class="line">  </span><br><span class="line">  - (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">      [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">      <span class="comment">// Do any additional setup after loading the view.</span></span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">  - (<span class="keyword">IBAction</span>)button:(<span class="keyword">id</span>)sender &#123;</span><br><span class="line">      <span class="comment">// 以下 API 仅为 iOS14 only</span></span><br><span class="line">      PHPickerConfiguration *configuration = [[PHPickerConfiguration alloc] init];</span><br><span class="line">      configuration.filter = [PHPickerFilter videosFilter]; <span class="comment">// 可配置查询用户相册中文件的类型，支持三种</span></span><br><span class="line">    configuration.selectionLimit = <span class="number">0</span>; <span class="comment">// 默认为1，为0时表示可多选。</span></span><br><span class="line">  </span><br><span class="line">      PHPickerViewController *picker = [[PHPickerViewController alloc] initWithConfiguration:configuration];</span><br><span class="line">      picker.delegate = <span class="keyword">self</span>;</span><br><span class="line">      <span class="comment">// picker vc，在选完图片后需要在回调中手动 dismiss</span></span><br><span class="line">    [<span class="keyword">self</span> presentViewController:picker animated:<span class="literal">YES</span> completion:^&#123;</span><br><span class="line">  </span><br><span class="line">      &#125;];</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line"><span class="meta">#pragma mark - Delegate</span></span><br><span class="line">  </span><br><span class="line">  - (<span class="keyword">void</span>)picker:(PHPickerViewController *)picker didFinishPicking:(<span class="built_in">NSArray</span>&lt;PHPickerResult *&gt; *)results &#123;</span><br><span class="line">      [picker dismissViewControllerAnimated:<span class="literal">YES</span> completion:<span class="literal">nil</span>];</span><br><span class="line">      <span class="keyword">if</span> (!results || !results.count) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">NSItemProvider</span> *itemProvider = results.firstObject.itemProvider;</span><br><span class="line">      <span class="keyword">if</span> ([itemProvider canLoadObjectOfClass:<span class="built_in">UIImage</span>.class]) &#123;</span><br><span class="line">          __<span class="keyword">weak</span> <span class="keyword">typeof</span>(<span class="keyword">self</span>) weakSelf = <span class="keyword">self</span>;</span><br><span class="line">          [itemProvider loadObjectOfClass:<span class="built_in">UIImage</span>.class completionHandler:^(__kindof <span class="keyword">id</span>&lt;<span class="built_in">NSItemProviderReading</span>&gt;  _Nullable object, <span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line">              <span class="keyword">if</span> ([object isKindOfClass:<span class="built_in">UIImage</span>.class]) &#123;</span><br><span class="line">                  __<span class="keyword">strong</span> <span class="keyword">typeof</span>(<span class="keyword">self</span>) strongSelf = weakSelf;</span><br><span class="line">                  <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                      strongSelf.imageView.image = (<span class="built_in">UIImage</span> *)object;</span><br><span class="line">                  &#125;);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;]; </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p> 需要注意的是，在 limit Photo 模式下，AssetsLibrary 访问相册会失败；在 writeOnly 模式下，AssetLibrary 也会有显示问题。建议还在使用 AssetsLibrary 的同学尽快迁移到新 API。</p><p> 授权相关：旧 API 废弃，增加 PHAccessLevel 参数。如果再使用以前的API来获取权限状态，</p><p>PHAuthorizationStatusLimited 状态下也会返回</p><p>PHAuthorizationStatusAuthorized</p><p><img src="https:////upload-images.jianshu.io/upload_images/3087124-5b1703f316220b84?imageMogr2/auto-orient/strip%7CimageView2/2/w/1080" alt="img"></p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ENUM</span>(<span class="built_in">NSInteger</span>, PHAccessLevel) &#123;</span><br><span class="line">  PHAccessLevelAddOnly = <span class="number">1</span>, <span class="comment">// 仅允许添加照片</span></span><br><span class="line">  PHAccessLevelReadWrite = <span class="number">2</span>, <span class="comment">// 允许访问照片，limitedLevel 必须为 readWrite</span></span><br><span class="line">&#125; API_AVAILABLE(macos(<span class="number">10.16</span>), ios(<span class="number">14</span>), tvos(<span class="number">14</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询权限</span></span><br><span class="line">PHAccessLevel level = PHAccessLevelReadWrite;</span><br><span class="line">PHAuthorizationStatus status = [PHPhotoLibrary authorizationStatusForAccessLevel:level];</span><br><span class="line">  <span class="keyword">switch</span> (status) &#123;</span><br><span class="line">      <span class="keyword">case</span> PHAuthorizationStatusLimited:</span><br><span class="line">          <span class="built_in">NSLog</span>(<span class="string">@"limited"</span>);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> PHAuthorizationStatusDenied:</span><br><span class="line">          <span class="built_in">NSLog</span>(<span class="string">@"denied"</span>);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> PHAuthorizationStatusAuthorized:</span><br><span class="line">          <span class="built_in">NSLog</span>(<span class="string">@"authorized"</span>);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 请求权限，需注意 limited 权限尽在 accessLevel 为 readAndWrite 时生效</span></span><br><span class="line">[PHPhotoLibrary requestAuthorizationForAccessLevel:level handler:^(PHAuthorizationStatus status) &#123;</span><br><span class="line">  <span class="keyword">switch</span> (status) &#123;</span><br><span class="line">      <span class="keyword">case</span> PHAuthorizationStatusLimited:</span><br><span class="line">          <span class="built_in">NSLog</span>(<span class="string">@"limited"</span>);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> PHAuthorizationStatusDenied:</span><br><span class="line">          <span class="built_in">NSLog</span>(<span class="string">@"denied"</span>);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> PHAuthorizationStatusAuthorized:</span><br><span class="line">          <span class="built_in">NSLog</span>(<span class="string">@"authorized"</span>);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">          <span class="keyword">break</span>; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure><h3 id="1-2-定位"><a href="#1-2-定位" class="headerlink" title="1.2. 定位"></a>1.2. <a name="Location"></a>定位</h3><p> 在 iOS13 及以前，App 请求用户定位授权时为如下形态：一旦用户同意应用获取定位信息，当前应用就可以获取到用户的精确定位。</p><p><img src="https:////upload-images.jianshu.io/upload_images/3087124-82305033df8c6067?imageMogr2/auto-orient/strip%7CimageView2/2/w/620" alt="img"></p><p> iOS14 新增用户大致位置选项可供用户选择，原因是大多数 App 实际上并不需要获取用户到用户最准确的定位信息。iOS14 授权弹窗新增的 Precise的开关默认会选中精确位置。用户通过这个开关可以进行更改，当把这个值设为 On 时，地图上会显示精确位置；切换为Off时，将显示用户的大致位置。</p><p> 对于对用户位置敏感度不高的 App 来说，这个似乎无影响，但是对于强依赖精确位置的 App 适配工作就显得非常重要了。可以通过用户在 “隐私设置” 中设置来开启精确定位，但是可能用户宁可放弃使用这个应用也不愿意开启。这个时候，iOS14 在 CLLocationManager 新增两个方法可用于向用户申请临时开启一次精确位置权限。</p><p><img src="https:////upload-images.jianshu.io/upload_images/3087124-de1a5c9607d2a07c?imageMogr2/auto-orient/strip%7CimageView2/2/w/1080" alt="img"></p><p>使用方式也很简单，需要首先在 Info.plist 中配置“NSLocationTemporaryUsageDescriptionDictionary”字典中需要配置 key 和 value 表明使用位置的原因，以及具体的描述。</p><p><img src="https:////upload-images.jianshu.io/upload_images/3087124-58d7ee154fa52e49?imageMogr2/auto-orient/strip%7CimageView2/2/w/1080" alt="img"></p><p>在本例中，key 即为获取用户权限时传的 “purposeKey”，最终呈现给用户的就是左图，右图为当App主动关闭精确定位权限申请。</p><p><img src="https:////upload-images.jianshu.io/upload_images/3087124-d9fb5bfefa4ea707?imageMogr2/auto-orient/strip%7CimageView2/2/w/574" alt="img"></p><p> 对于地理位置不敏感的App 来说，iOS14 也可以通过直接在 info.plist 中添加 NSLocationDefaultAccuracyReduced 为 true 默认请求大概位置。</p><p><img src="https:////upload-images.jianshu.io/upload_images/3087124-f337e1c00dd71a9f?imageMogr2/auto-orient/strip%7CimageView2/2/w/1080" alt="img"></p><p> 这样设置之后，即使用户想要为该 App 开启精确定位权限，也无法开启。</p><p> 也可以直接通过API来根据不同的需求设置不同的定位精确度。</p><p><img src="https:////upload-images.jianshu.io/upload_images/3087124-9e67f5a736463a45?imageMogr2/auto-orient/strip%7CimageView2/2/w/1080" alt="img"></p><p> 需要注意的是，当 App 在 Background 模式下，如果并未获得精确位置授权，那么 Beacon 及其他位置敏感功能都将受到限制。</p><p><strong>总结</strong>：经过实践，以中科大厦为例，模糊定位与精准定位，直线距离相差1.2公里</p><h3 id="1-3-UIDatePicker"><a href="#1-3-UIDatePicker" class="headerlink" title="1.3. UIDatePicker"></a>1.3. <a name="UIDatePicker"></a>UIDatePicker</h3><p> iOS 13.4 新增了2个属性 preferredDatePickerStyle 和 datePickerStyle</p><p>而 preferredDatePickerStyle 在 iOS14 以上被默认为UIDatePickerStyleAutomatic，就会显示新增的 UIDatePickerStyleInline 效果，如果我们需要按之前的经典样式显示，则需要判断系统版本适配</p><p>iOS14 以后UIDatePicker 新增了样式，并且默认为新样式，长这样：</p><h4><a href="#" class="headerlink"></a></h4><p><img src="https:////upload-images.jianshu.io/upload_images/2147212-23f08cb4058db5ea.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/726" alt="img"></p><p>造成这种情况的原因在于 iOS 13.4 新增了2个属性 preferredDatePickerStyle 和 datePickerStyle</p><p>而 preferredDatePickerStyle 在 iOS14 以上被默认为UIDatePickerStyleAutomatic，就会显示新增的 UIDatePickerStyleInline 效果，如果我们需要按之前的经典样式显示，则需要判断系统版本适配</p><h4 id="13-1-代码布局适配"><a href="#13-1-代码布局适配" class="headerlink" title="13.1. 代码布局适配"></a>13.1. 代码布局适配</h4><p>在原代码基础上需要加入以下代码，调整样式：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if (@available(iOS 13.4, *)) &#123;</span><br><span class="line"></span><br><span class="line">​    self.datePickerMy.preferredDatePickerStyle = UIDatePickerStyleWheels;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>*提示：设置 style 之后，还需要重新设置 picker 的 frame，否则布局宽高会有异常</p><h4 id="13-2-XIB-布局"><a href="#13-2-XIB-布局" class="headerlink" title="13.2. XIB 布局"></a>13.2. XIB 布局</h4><p>xib 适配相对简单，只需要将 Style 设置为 Wheels 即可显示为经典样式，如下图：</p><p><img src="https:////upload-images.jianshu.io/upload_images/2147212-cabd76ec849115ce.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/496" alt="img"></p><h3 id="1-4-UITableViewCell"><a href="#1-4-UITableViewCell" class="headerlink" title="1.4. UITableViewCell"></a>1.4. <a name="UITableViewCell"></a>UITableViewCell</h3><p> iOS14 更新后，很多自定义tableViewCell不能点击,查看图层及分析,发现是iOS14开始,UITableViewCell上的content已处于图层顶层,原来cell 上 addSubview,被contentView遮挡。因此需要将原来 cell中的 [self addSubview:xxxSubview]; 改为 [self.contentView addSubview:xxxSubview];</p><h3 id="1-5-Local-Network"><a href="#1-5-Local-Network" class="headerlink" title="1.5. Local Network"></a>1.5. <a name="LocalNetwork"></a>Local Network</h3><p> iOS14 当 App 要使用 Bonjour 服务时或者访问本地局域网，使用 mDNS 服务等，都需要授权，开发者需要在 Info.plist 中详细描述使用的为哪种服务以及用途。下图为无需申请权限和需要授权的服务：</p><p><img src="https:////upload-images.jianshu.io/upload_images/3087124-e9efaa10cebb7f62?imageMogr2/auto-orient/strip%7CimageView2/2/w/1080" alt="img"></p><p>具体调用的模块如:<br>Network.framework（NWBrowser，NWListener.Service）<br>Foundation（NetService）<br>MultipeerConnectivity（蓝牙）<br>Dnssd（发现，发布和解析局域网或广域网上的网络服务）</p><p>Bonjour主要做本地通信和只能交互的。<br>通常我们是通过 NSNetService 和 NSNetServiceBrowser 来使用 Bonjour 的，前者用于建立与发布 service，后者用于监听查询网络上的 service。</p><p> 在 “隐私设置” 中也可以查看和修改具体有哪些 App 正在使用 LocalNetwork</p><p><img src="https:////upload-images.jianshu.io/upload_images/3087124-996ee477fb17e86c?imageMogr2/auto-orient/strip%7CimageView2/2/w/518" alt="img"></p><p> 如果应用中需要使用 LocalNetwork 需要在 Info.plist 中配置两个选项，详细描述为什么需要使用该权限，以及需要列出具体使用 LocalNetwork 的服务列表。</p><p><img src="https:////upload-images.jianshu.io/upload_images/3087124-2ebdb79306b74fb3?imageMogr2/auto-orient/strip%7CimageView2/2/w/1080" alt="img"></p><p> 对于使用了下列包含 Bonjour 的 framework，都需要更新描述.<br><a href="https:////upload-images.jianshu.io/upload_images/3087124-c49f0177ba913bbd?imageMogr2/auto-orient/strip|imageView2/2/w/1080" target="_blank" rel="noopener">img</a>image</p><h3 id="1-6-Wi-Fi-Address"><a href="#1-6-Wi-Fi-Address" class="headerlink" title="1.6. Wi-Fi Address"></a>1.6. <a name="Wi-FiAddress"></a>Wi-Fi Address</h3><p> iOS8 - iOS13 ，用户在不同的网络间切换和接入时，mac 地址都不会改变，这也就使得网络运营商还是可以通过 mac 地址对用户进行匹配和用户信息收集，生成完整的用户信息。iOS14 提供 Wifi 加密服务，每次接入不同的 WiFi 使用的 mac 地址都不同。每过 24 小时，mac 地址还会更新一次。需要关注是否有使用用户网络 mac 地址的服务。</p><p> 下图为 iOS13 及之前用户接入网络时 mac 地址并不会进行改变</p><p><img src="https:////upload-images.jianshu.io/upload_images/3087124-b3c7f1e3955af3f8?imageMogr2/auto-orient/strip%7CimageView2/2/w/1080" alt="img"></p><p> 下图为 iOS14 用户接入 Wi-Fi 时 mac 地址的变化情况</p><p><img src="https:////upload-images.jianshu.io/upload_images/3087124-6fe8f2e488921406?imageMogr2/auto-orient/strip%7CimageView2/2/w/1080" alt="img"></p><p> 并且用户也可以自行选择是否开启 private Wi-Fi address</p><p><img src="https:////upload-images.jianshu.io/upload_images/3087124-2d1fa92875405fde?imageMogr2/auto-orient/strip%7CimageView2/2/w/1080" alt="img"></p><p> 获取用户接入WiFi时的mac地址(注意：需要调试证书中配置权限 Target-&gt; Capabilities-&gt; Access WiFi Information-&gt; ON, 否则 bssid = nil)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">//引入对应的头文件</span><br><span class="line">#import &lt;SystemConfiguration/CaptiveNetwork.h&gt;</span><br><span class="line"></span><br><span class="line">//获取mac地址</span><br><span class="line">+(NSString *)MacAddress</span><br><span class="line">&#123;</span><br><span class="line">    NSArray *ifs = CFBridgingRelease(CNCopySupportedInterfaces());</span><br><span class="line">    id info = nil;</span><br><span class="line">    for (NSString *ifnam in ifs) &#123;</span><br><span class="line">        info = (__bridge_transfer id)CNCopyCurrentNetworkInfo((CFStringRef)ifnam);</span><br><span class="line">        if (info &amp;&amp; [info count]) &#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    NSDictionary *dic = (NSDictionary *)info;</span><br><span class="line">    NSString *ssid = [[dic objectForKey:@&quot;SSID&quot;] lowercaseString];</span><br><span class="line">    NSString *bssid = [dic objectForKey:@&quot;BSSID&quot;];</span><br><span class="line">    NSLog(@&quot;ssid:%@ \nssid:%@&quot;,ssid,bssid);</span><br><span class="line">    return bssid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-7-剪切板"><a href="#1-7-剪切板" class="headerlink" title="1.7. 剪切板"></a>1.7. <a name="Pasteboard"></a>剪切板</h3><p> 在 iOS14 中，读取用户剪切板的数据会弹出提示。</p><p><img src="https:////upload-images.jianshu.io/upload_images/3087124-63c3ff2b2e11e8e2?imageMogr2/auto-orient/strip%7CimageView2/2/w/592" alt="img"></p><p> 弹出提示的原因是使用 UIPasteboard 访问用户数据，访问以下数据都会弹出 toast 提示。</p><p><img src="https:////upload-images.jianshu.io/upload_images/3087124-498d6fdaba5d8af1?imageMogr2/auto-orient/strip%7CimageView2/2/w/1080" alt="img"></p><p> 兼容方案：如果应用访问剪切板仅仅用于判断是否为URL格式，则 iOS14 新增了两个 API 可以用于规避该提示。如果应用想直接访问剪切板的数据，暂时可能无法做到规避该提示。iOS14 新增两种</p><p>UIPasteboardDetectionPattern。</p><p><img src="https:////upload-images.jianshu.io/upload_images/3087124-e1da7de91a7f8157?imageMogr2/auto-orient/strip%7CimageView2/2/w/1080" alt="img"></p><p> 上面的两个 API 可用于规避提示，但只能用于判断剪切板中是否有 URL，并不是真正的访问剪贴板数据，也拿不到剪切板的真实数据。下面两个 API 可以获得具体的 URL 信息，但是会触发剪切板提示。并且实测当用户剪切板中包含多个 URL 时只会返回第一个。</p><p><img src="https:////upload-images.jianshu.io/upload_images/3087124-9d13c2434c6ff7ee?imageMogr2/auto-orient/strip%7CimageView2/2/w/1080" alt="img"></p><p> 使用示例</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSSet</span> *patterns = [[<span class="built_in">NSSet</span> alloc] initWithObjects:<span class="built_in">UIPasteboardDetectionPatternProbableWebURL</span>, <span class="literal">nil</span>];</span><br><span class="line">[[<span class="built_in">UIPasteboard</span> generalPasteboard] detectPatternsForPatterns:patterns completionHandler:^(<span class="built_in">NSSet</span>&lt;<span class="built_in">UIPasteboardDetectionPattern</span>&gt; * _Nullable result, <span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line">    <span class="keyword">if</span> (result &amp;&amp; result.count) &#123;</span><br><span class="line">            <span class="comment">// 当前剪切板中存在 URL</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure><h3 id="1-8-相机和麦克风"><a href="#1-8-相机和麦克风" class="headerlink" title="1.8. 相机和麦克风"></a>1.8. <a name="Record"></a>相机和麦克风</h3><p> iOS14 中 App 使用相机和麦克风时会有图标提示以及绿点和黄点提示，并且会显示当前是哪个 App 在使用此功能。我们无法控制是否显示该提示。</p><p><img src="https:////upload-images.jianshu.io/upload_images/3087124-be9dbdf3195e0f48?imageMogr2/auto-orient/strip%7CimageView2/2/w/912" alt="img"></p><p> 会触发录音小黄点的代码示例：</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">AVAudioRecorder</span> *recorder = [[<span class="built_in">AVAudioRecorder</span> alloc] initWithURL:recorderPath settings:<span class="literal">nil</span> error:<span class="literal">nil</span>];</span><br><span class="line">[recorder record];</span><br></pre></td></tr></table></figure><p> 触发相机小绿点的代码示例:</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">AVCaptureDeviceInput</span> *videoInput = [[<span class="built_in">AVCaptureDeviceInput</span> alloc] initWithDevice:videoCaptureDevice error:<span class="literal">nil</span>];</span><br><span class="line"><span class="built_in">AVCaptureSession</span> *session = [[<span class="built_in">AVCaptureSession</span> alloc] init];</span><br><span class="line"><span class="keyword">if</span> ([session canAddInput:videoInput]) &#123;</span><br><span class="line">    [session addInput:videoInput];</span><br><span class="line">&#125;</span><br><span class="line">[session startRunning];</span><br></pre></td></tr></table></figure><h3 id="1-9-IDFA"><a href="#1-9-IDFA" class="headerlink" title="1.9. IDFA"></a>1.9. <a name="IDFA"></a>IDFA</h3><p> IDFA 全称为 Identity for Advertisers ，即广告标识符。用来标记用户，目前最广泛的用途是用于投放广告、个性化推荐等。</p><p> 在 iOS13 及以前，系统会默认为用户开启允许追踪设置，我们可以简单的通过代码来获取到用户的 IDFA 标识符。</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ([[ASIdentifierManager sharedManager] isAdvertisingTrackingEnabled]) &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *idfaString = [[ASIdentifierManager sharedManager] advertisingIdentifier].UUIDString;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, idfaString);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> 但是在 iOS14 中，这个判断用户是否允许被追踪的方法已经废弃。</p><p><img src="https:////upload-images.jianshu.io/upload_images/3087124-b5348d95b07109fe.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/978" alt="img"></p><p> iOS14 中，系统会默认为用户关闭广告追踪权限。</p><p><img src="https:////upload-images.jianshu.io/upload_images/3087124-a01ea1893adaabf7?imageMogr2/auto-orient/strip%7CimageView2/2/w/1080" alt="img"></p><p> 对于这种情况，我们需要去请求用户权限。首先需要在 Info.plist 中配置” NSUserTrackingUsageDescription “ 及描述文案，接着使用 AppTrackingTransparency 框架中的 ATTrackingManager 中的 requestTrackingAuthorizationWithCompletionHandler 请求用户权限，在用户授权后再去访问 IDFA 才能够获取到正确信息。</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;AppTrackingTransparency/AppTrackingTransparency.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;AdSupport/AdSupport.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)testIDFA &#123;</span><br><span class="line">    <span class="keyword">if</span> (@available(iOS <span class="number">14</span>, *)) &#123;</span><br><span class="line">        [ATTrackingManager requestTrackingAuthorizationWithCompletionHandler:^(ATTrackingManagerAuthorizationStatus status) &#123;</span><br><span class="line">            <span class="keyword">if</span> (status == ATTrackingManagerAuthorizationStatusAuthorized) &#123;</span><br><span class="line">                <span class="built_in">NSString</span> *idfaString = [[ASIdentifierManager sharedManager] advertisingIdentifier].UUIDString;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 使用原方式访问 IDFA</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-10-上传-AppStore"><a href="#1-10-上传-AppStore" class="headerlink" title="1.10. 上传 AppStore"></a>1.10. <a name="AppStore"></a>上传 AppStore</h3><p>更加严格的隐私审核，可以让用户在下载 App 之前就知道此 App 将会需要哪些权限。目前苹果商店要求所有应用在上架时都必须提供一份隐私政策。如果引入了第三方收集用户信息等SDK，都需要向苹果说明是这些信息的用途。</p><p><img src="https:////upload-images.jianshu.io/upload_images/3087124-228dd7cf118b110c?imageMogr2/auto-orient/strip%7CimageView2/2/w/1080" alt="img"></p><p><img src="https:////upload-images.jianshu.io/upload_images/3087124-586e94bbc708b9bf?imageMogr2/auto-orient/strip%7CimageView2/2/w/1080" alt="img"></p><h2 id="2-总结"><a href="#2-总结" class="headerlink" title="2. 总结"></a>2. <a name="Conclusion"></a><strong>总结</strong></h2><hr><p>对于这次 iOS14 的隐私权限大升级和新尝试，体现了苹果对于用户隐私的尊重。</p><p>从用户角度来说，近年来越来越精准的广告投放让我们越来越感觉自己被”监视“着，此次升级后，我们有了更多保护自己隐私的方式以及避免广告骚扰的方法，苹果此举无疑会加大我们对其的好感度和信任感。但从另一个角度来说，对于 IDFA 的限制，可能会导致之前许多依靠广告投放收入的免费 App 难以继续维持生计，也可能也会导致免费 App 的数量有所降低。从开发者的角度来说，除了对 iOS14 隐私升级的积极适配外，也让我们感受到了 iOS14 中对于用户隐私的重视无疑会提高获取用户行为信息的成本。</p><p>冲击最大的应该就是广告行业，对于目前的推荐算法和用户拉新都会受到影响，如何在充分尊重用户隐私的前提下进行广告的精准投放对于开发者和广告商来说都是一个不小的机遇和挑战。</p><div class="post-announce">感谢您的阅读，本文由 <a href="https://JohnyLisir.github.io">JohnyLisir</a> 版权所有。如若转载，请注明出处：JohnyLisir（<a href="https://JohnyLisir.github.io/2021/02/19/iOS14新特性及适配/">https://JohnyLisir.github.io/2021/02/19/iOS14新特性及适配/</a>）</div><div class="post__prevs"><div class="post__prev"><a href="/2019/10/21/关于本地服务live-server的使用/" title="关于本地服务live-server的使用"><i class="iconfont icon-prev"></i>关于本地服务live-server的使用</a></div><div class="post__prev post__prev--right"></div></div></div></article></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">文章分类</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/iOS/">iOS</a><span class="block-list-count">5</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Web/">Web</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/React-native/">React-native</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Python/">Python</a><span class="block-list-count">2</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Git/">Git</a><span class="block-list-count">3</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Blog/">Blog</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/APK/">APK</a><span class="block-list-count">1</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">最新文章</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/2021/02/19/iOS14新特性及适配/" title="iOS14新特性及适配"><div class="item__cover"><img src="http://blog.static.minfive.com/post/18-08-05/843d1948e85e20653861c115389cc7cf.jpg" alt="iOS14新特性及适配"></div><div class="item__info"><h3 class="item__title">iOS14新特性及适配</h3><span class="item__text">2021-02-19</span></div></a></li><li class="latest-post-item"><a href="/2019/10/21/关于本地服务live-server的使用/" title="关于本地服务live-server的使用"><div class="item__cover"><img src="http://blog.static.minfive.com/post/18-08-05/843d1948e85e20653861c115389cc7cf.jpg" alt="关于本地服务live-server的使用"></div><div class="item__info"><h3 class="item__title">关于本地服务live-server的使用</h3><span class="item__text">2019-10-21</span></div></a></li><li class="latest-post-item"><a href="/2019/09/18/blog教程/" title="Blog创建教程"><div class="item__cover"><img src="http://blog.static.minfive.com/post/18-08-05/843d1948e85e20653861c115389cc7cf.jpg" alt="Blog创建教程"></div><div class="item__info"><h3 class="item__title">Blog创建教程</h3><span class="item__text">2019-09-18</span></div></a></li><li class="latest-post-item"><a href="/2019/09/04/react-native 与原生混合开发/" title="react-native 与原生混合开发教程"><div class="item__cover"><img src="https://cn.bing.com/th?id=OIP.kQ11_TLArd7xGuWiSomBSgHaEJ&pid=Api&rs=1" alt="react-native 与原生混合开发教程"></div><div class="item__info"><h3 class="item__title">react-native 与原生混合开发教程</h3><span class="item__text">2019-09-04</span></div></a></li></ul></div><div class="sidebar__block"><h3 class="block__title">文章标签</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/APK/">APK</a></li><li class="tag-item"><a class="tag-link" href="/tags/Blog/">Blog</a></li><li class="tag-item"><a class="tag-link" href="/tags/Cocoapods/">Cocoapods</a></li><li class="tag-item"><a class="tag-link" href="/tags/Git/">Git</a></li><li class="tag-item"><a class="tag-link" href="/tags/Mac-app/">Mac-app</a></li><li class="tag-item"><a class="tag-link" href="/tags/Python/">Python</a></li><li class="tag-item"><a class="tag-link" href="/tags/React/">React</a></li><li class="tag-item"><a class="tag-link" href="/tags/React-native/">React-native</a></li><li class="tag-item"><a class="tag-link" href="/tags/Server/">Server</a></li><li class="tag-item"><a class="tag-link" href="/tags/Web/">Web</a></li><li class="tag-item"><a class="tag-link" href="/tags/iOS/">iOS</a></li><li class="tag-item"><a class="tag-link" href="/tags/iOS-Update/">iOS-Update</a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">关于</h3><div class="item__content"><p class="item__text">本站是基于 Hexo 搭建的静态资源博客，主要用于分享日常学习、生活及工作的一些心得总结，欢迎点击右下角订阅 rss。</p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>Shenzhen, Guangdong Province, China</span></li><li class="contact-info__item"><i class="iconfont icon-email2"></i> <span>json9025@gmail.com</span></li></ul></div></div><div class="footer-top__item footer__image"><img src="https://tse3-mm.cn.bing.net/th/id/OIP.9mdniIPjAJJeHiOCdgBCbQAAAA?pid=Api&rs=1" alt="logo" title="JohnyLisir"></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">© <a href="https://github.com/Mrminfive/hexo-theme-skapp" target="_blank">Skapp</a> 2017 powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, made by <a href="https://github.com/Mrminfive" target="_blank">minfive</a>.</p><ul class="footer__social-network clearfix"><li class="social-network__item"><a href="https://github.com/JohnyLisir" target="_blank" title="github"><i class="iconfont icon-github"></i></a></li><li class="social-network__item"><a href="mailto:Json163vip@163.com" target="_blank" title="email"><i class="iconfont icon-email"></i></a></li></ul></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>